pro new_sn1987a_results,exclude=exclude,show=show,ps=ps,_extra=_extra,title2=title2,ring=ring,ptsrc=ptsrc,lobes=lobes
  
  if not keyword_set(ring) and not keyword_set(ptsrc) and not keyword_set(lobes) then begin
     print,'Must set ring,ptsrc,or lobes'
     return
  endif 
  
  if keyword_set(ring) then begin
     dof0=6
     mdir='ring/'
  endif 
  if keyword_set(ptsrc) then begin
     dof0=18
     mdir='ptsrc/'
  endif 
  if keyword_set(lobes) then begin
     dof0=18
     mdir='lobes/'
  endif 
  
  if n_elements(title2) eq 0 then title2=''
  if not keyword_set(exclude) then exclude=0
  n=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]
  dir=!data+'sn1987a/image_analysis/'
  files=dir+['sn1987a1_300-8000_cr.fits','sn1987a2_300-8000_cr.fits','sn1987a3_300-8000_cr.fits','sn1987a4_300-8000_cr.fits','sn1987a5_300-8000_cr.fits','sn1987a6_300-8000_cr.fits','sn1987a7_300-8000_cr.fits','sn1987a8_300-8000_cr.fits','sn1987a9_300-8000_cr.fits','sn1987a10_300-8000_cr.fits','sn1987a11_300-8000_cr.fits','sn1987a12_300-8000_cr.fits','sn1987a13_300-8000_cr.fits','sn1987a14_300-8000_cr.fits','sn1987a15_300-8000_cr.fits']
  nn=n_elements(files)
  fpars=mrdfits(mdir+'new_sn1987a_fpars.fits',1,/silent)
;  dof0=lonarr(nn)
  if keyword_set(show) then begin 
     !p.multi=[0,2,2]
     i=0
 ;    for i=0,nn-1 do begin
     while i lt nn do begin 
        im=mrdfits(files[i],/silent)
        ofile='new_sn1987a'+ntostr(n[i])+'_fitim.fits'
        newim=mrdfits(ofile,0,/silent)
        fitim=mrdfits(ofile,1,/silent)
        diff=mrdfits(ofile,2,/silent)
        w=where(im gt mean(im),nw)
;        dof0[i]=nw
        rdis,im,title='Image '+ntostr(n[i]),/silent
        rdis,newim,title='Deprojected image',/silent
        tvcircle,fpars[i].r0,fpars[i].x0+100.,fpars[i].y0+100,!green,/data
        rdis,fitim,title='Fit model image',/silent
        tvcircle,fpars[i].r0,fpars[i].x0+100.,fpars[i].y0+100,!green,/data
        rdis,diff,title='Residuals',/silent
        k=get_kbrd(10)
        if k eq 'n' then i=i+1
        if k eq 'p' then i=i-1
        if k eq 'q' then i=nn
     endwhile
;     endfor 

     !p.multi=0
  endif 
  
  sn1987a_age,ages
  scale=0.01475;*25.
  cos43=cos(43.*!dtor)
;  dof=dof-22.
;  w=where(dof lt 0,nw)
;  if nw gt 0 then dof[w]=22.
  counts=[690,607,9016,1800,6226,6427,9227,9668,11856,17979,16557,24939,27048,31048,35000]
  dof=counts-dof0

  r0=fpars.r0*scale;*cos43 ;reprojects v to compare to radio/opt/ir
  r0err=fpars.r0err*scale*sqrt(fpars.chisq/dof)*5.
  ind=indgen(15)
;  ind=[ind[0:4],ind[6:*]]
  r0=r0[ind]
  r0err=r0err[ind]
  dof=dof[ind]
  ages=ages[ind]
  
  plotsym,0,/fill
  
  if keyword_set(ps) then begplot,name='new_sn1987a_expansion_results.ps',/color,/land
    
  ploterror,ages,r0,r0err,psym=8,xtitle='Time since SN (days)',ytitle='r!L0!N (arcsec)',title='SN1987a expansion measure'+title2,_extra=_extra
  g=where(r0 GT 0)
  if not exclude then g0=g[0:8] else g0=g[0:8]
  f0=linfit(ages[g0],r0[g0],measure_errors=r0err[g0],yfit=yfit,sigma=sigma0,chisq=chisq0)
  oplot,[ages[g0],6266],[ages[g0],6266]*f0[1]+f0[0],color=!blue
  if not exclude then g1=g[8:*] else g1=g[[8,9,11,12,14]]
  f1=linfit(ages[g1],r0[g1],measure_errors=r0err[g1],yfit=yfit,sigma=sigma1,chisq=chisq1)
  oplot,ages[g1],ages[g1]*f1[1]+f1[0],color=!red
  d=1.54285e18 ;km to LMC
  f2=linfit(ages[g],r0[g],measure=r0err[g],yfit=yfit,sigma=sigma2,chisq=chisq2)
  b=[f0[1],0,f1[1],0,f2[1]] 
  expr=d*(b*!dtor/3600.)/86400D 
  exprerr=d*([sigma0[1],0,sigma1[1],0,sigma2[1]]*!dtor/3600.)/86400D
  oplot,ages[g],yfit,color=!green,line=2
  print,expr,exprerr
  
  chisq=[chisq0,0,chisq1,0,chisq2]
  dofc=[(n_elements(g0)-2),0,(n_elements(g1)-2),0,(n_elements(g)-2)]*1d
  cdf=chisq/dofc
  print,'chisq = ',chisq0,chisq1,chisq2
  print,'dof = ',(n_elements(g0)-2),(n_elements(g1)-2),(n_elements(g)-2)
  print,'chisq/dof = ',chisq0/(n_elements(g0)-2),chisq1/(n_elements(g1)-2),chisq2/(n_elements(g)-2)
  txt=['v!Lexpansion!N = '+ntostr(round(expr))+' '+!tsym.plusminus+' '+ntostr(round(exprerr))+' km s!U-1!N   [']+!tsym.chi+'!U2!N/dof = '+sigfig(cdf,4)+']'
  txt[[1,3]]=''
  
  legend,[txt],box=0,/bottom,/right,charsize=2,textcolor=[!blue,!white,!red,!white,!green]

  
  ticpt=(f0[0]-f1[0])/(f1[1]-f0[1])
  icpt=f1[0]+f1[1]*ticpt
  p0=sqrt(chisq0/(total(dofc[g0])-n_elements(g0)))
  p1=sqrt(chisq1/(total(dofc[g1])-n_elements(g1)))
  p2=sqrt(chisq2/(total(dofc[g])-n_elements(g2)))
  a=f0[0]*p0 & b=f0[1]*p0 & c=f1[0]*p1 & d=f1[1]*p1
  siga=sigma0[0]*p0 & sigb=sigma0[1]*p0 & sigc=sigma1[0]*p1 & sigd=sigma1[1]*p1
  ticpterr=sqrt((1/(d-b))^2*siga^2+(2*(a-c)/(d-b)^2)^2*sigb^2+(-1/(d-b))^2*sigc^2+(-2*(a-c)/(d-b)^2)^2*sigd^2)
  ;;;PRETTY SURE THIS IS INCORRECT
  
  if keyword_set(ps) then endplot
  
  print,icpt,ticpt,ticpterr
    
  stop
  return
end 
