pro new_sn1987a_image_analysis,lobes=lobes,ring=ring,ptsrc=ptsrc
  
  if not keyword_set(lobes) and not keyword_set(ring) and not keyword_set(ptsrc) then begin 
     print,'Need to specify model (lobes, ring, ptsrc)'
     return
  endif 
  
;  n=[1,6]
  n=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]
  dir='~jracusin/data/sn1987a/image_analysis/'
  files=dir+['sn1987a1_300-8000_cr.fits','sn1987a2_300-8000_cr.fits','sn1987a3_300-8000_cr.fits','sn1987a4_300-8000_cr.fits','sn1987a5_300-8000_cr.fits','sn1987a6_300-8000_cr.fits','sn1987a7_300-8000_cr.fits','sn1987a8_300-8000_cr.fits','sn1987a9_300-8000_cr.fits','sn1987a10_300-8000_cr.fits','sn1987a11_300-8000_cr.fits','sn1987a12_300-8000_cr.fits','sn1987a13_300-8000_cr.fits','sn1987a14_300-8000_cr.fits','sn1987a15_300-8000_cr.fits']
  nn=n_elements(files)
  
    fpars=create_struct('a0',0d,'a0err',0d,'a1',0d,'a1err',0d,$
                        'x0',0d,'x0err',0d,'y0',0d,'y0err',0d,$
                        'sigr',0d,'sigrerr',0d,'r0',0d,'r0err',0d,$
                        's0',0d,'s0err',0d,'theta0',0d,'theta0err',0d,$
                        'sigt0',0d,'sigt0err',0d,'sigr0',0d,'sigr0err',0d,$
                        's1',0d,'s1err',0d,'theta1',0d,'theta1err',0d,$
                        'sigt1',0d,'sigt1err',0d,'sigr1',0d,'sigr1err',0d,$
                        's2',0d,'s2err',0d,'theta2',0d,'theta2err',0d,$
                        'sigt2',0d,'sigt2err',0d,'sigr2',0d,'sigr2err',0d,$
                        's3',0d,'s3err',0d,'theta3',0d,'theta3err',0d,$
                        'sigt3',0d,'sigt3err',0d,'sigr3',0d,'sigr3err',0d,$
                        'counts',0d,'iter',0,'chisq',0d)
  
  
;  fpars=create_struct('a0',0d,'a0err',0d,'a1',0d,'a1err',0d,$
;                      'x0',0d,'x0err',0d,'y0',0d,'y0err',0d,$
;                      'sigx',0d,'sigxerr',0d,$
;                      'sigy',0d,'sigyerr',0d,$
;                      'b1',0d,'b1err',0d,'r0',0d,'r0err',0d,$
;                      'theta0',0d,'theta0err',0d,$
;                      'sigr',0d,'sigrerr',0d,'sigt',0d,'sigterr',0d,$
;                      'c0',0d,'c0err',0d,'c1',0d,'c1err',0d,'phi0',0d,'phi0err',0d,$
;                      'counts',0d,'countserr',0d,'mu0',0d,'mu0err',0d,$
;                      'sigt2',0d,'sigt2err',0d,'b2',0d,'b2err',0d,'chisq',0d,'iter',0)
  
;  fpars=create_struct('a0',0d,'a1',0d,'x0',0d,'y0',0d,'sigx',0d,'sigy',0d,$
;                      'b1',0d,'r0',0d,'theta0',0d,'sigr',0d,'sigt',0d,$
;                      'c0',0d,'c1',0d,'phi0',0d,'counts',0d,'mu0',0d,$
;                      'sigt2',0d,'b2',0d,'chisq',0d,'iter',0,$
;                      'r0err',fltarr(2),$
;                      'x0err',0d,'y0err',0d)
  npars=n_tags(fpars)
  fpars=replicate(fpars,nn)
  r0=dblarr(nn)
  !p.multi=[0,3,3]
  for i=0,nn-1 do begin
     
     im=mrdfits(files[i])
     deproject_image,im,newim
     
;     sn1987a_fit,newim,a,fitim,chisq,iter,sigma,r0errs,i,stack=stack
     


     new_sn1987a_fit,newim,a,sigma,chisq,iter,fitim,lobes=lobes,ring=ring,ptsrc=ptsrc
;     !p.multi=0
     rdis,im
     rdis,newim
     rdis,fitim
     
;     for j=0,n_elements(a)-1 do fpars[i].(j)=a[j]
     for j=0,npars-3,2 do fpars[i].(j)=a[j/2]
     
;     dof=200.^2-22.
;     csigma=sigma*sqrt(chisq/dof)
     for j=1,npars-2,2 do fpars[i].(j)=sigma[(j-1)/2]
     r0[i]=a[7]
     fpars[i].iter=iter
     fpars[i].chisq=chisq
     
     ofile='new_sn1987a'+ntostr(n[i])+'_fitim.fits'
     mwrfits,newim,ofile,/create
     mwrfits,fitim,ofile
     diff=newim-fitim
     mwrfits,diff,ofile
    
  endfor 
  print,r0
  mwrfits,fpars,'new_sn1987a_fpars.fits',/create
  
  !p.multi=0
  return
end 
